"use strict";!function(){window.console=window.console||{},window.console.assert=window.console.assert||function(){},window.console.error=window.console.error||function(){};function n(e){var n=this;this.images=e.images,this.startingZoom=e.zoom,this.startingPan=e.pan,this.isMobile=void 0!==window.orientation||-1!==navigator.userAgent.indexOf("IEMobile"),this.isMobile?(this.clipFactorX=.5,this.clipFactorY=.5):(this.clipFactorX=0,this.clipFactorY=0),OpenSeadragon.EventSource.call(this);var i=e.osdOptions;i.element=e.container,this.viewer=OpenSeadragon(i),this.viewer.canvas.style.outline="none",this.tracker=new OpenSeadragon.MouseTracker({element:this.viewer.canvas,moveHandler:function(e){n.isMobile||n.dragClip(e.position,!0,!0)},pressHandler:function(e){if(n.isMobile){var i=n.getShownImages();if(!(i.length<=1)){var t=new OpenSeadragon.Point(n.viewer.container.clientWidth*n.clipFactorX,n.viewer.container.clientHeight*n.clipFactorY);2===i.length?Math.abs(t.x-e.position.x)<20&&(n.isDraggingClipX=!0):3===i.length&&(Math.abs(t.x-e.position.x)<20&&e.position.y<t.y+20&&(n.isDraggingClipX=!0),Math.abs(t.y-e.position.y)<20&&(n.isDraggingClipY=!0))}}},releaseHandler:function(e){n.isDraggingClipX=!1,n.isDraggingClipY=!1}}),this.viewer.addHandler("viewport-change",function(){n.updateClip(),n.raiseEvent("change:viewport")}),this.viewer.addHandler("add-item-failed",function(e){n.raiseEvent("add-item-failed",e)}),this.viewer.addHandler("canvas-drag",function(e){(n.isDraggingClipX||n.isDraggingClipY)&&(e.preventDefaultAction=!0,n.dragClip(e.position,n.isDraggingClipX,n.isDraggingClipY))}),this.images.forEach(function(i,t){i.curtain={},n.viewer.addTiledImage({tileSource:i.tileSource,opacity:i.shown,success:function(e){i.curtain.tiledImage=e.item,i.curtain.tiledImage.setOpacity(i.shown?1:0),0===t&&(n.startingZoom&&n.viewer.viewport.zoomTo(n.startingZoom,null,!0),n.startingPan&&n.viewer.viewport.panTo(n.startingPan,!0)),n.updateClip()}})})}n.prototype=OpenSeadragon.extend({destroy:function(){this.images.forEach(function(e){delete e.curtain}),this.tracker.destroy(),this.viewer.destroy()},getZoom:function(){return this.viewer.viewport.getZoom()},setZoom:function(e){this.viewer.viewport.zoomTo(e,null,!0),this.startingZoom=e},getPan:function(){return this.viewer.viewport.getCenter()},setPan:function(e){this.viewer.viewport.panTo(e,!0),this.startingPan=e},zoomIn:function(){this.viewer.viewport.zoomBy(this.viewer.zoomPerClick),this.viewer.viewport.applyConstraints()},zoomOut:function(){this.viewer.viewport.zoomBy(1/this.viewer.zoomPerClick),this.viewer.viewport.applyConstraints()},updateImageShown:function(e){e.curtain.tiledImage&&e.curtain.tiledImage.setOpacity(e.shown?1:0)},updateClip:function(){var e,i,t,n,o=new OpenSeadragon.Point(this.viewer.container.clientWidth*this.clipFactorX,this.viewer.container.clientHeight*this.clipFactorY),a=this.viewer.viewport.pointFromPixel(o,!0),r=this.getShownImages();if(1<r.length&&(e=r[1].curtain.tiledImage)){i=e.getContentSize(),t=e.viewportToImageCoordinates(a);var s=Math.min(i.x,Math.max(0,t.x));n=new OpenSeadragon.Rect(s,0,i.x,i.y),e.setClip(n)}if(2<r.length&&(e=r[2].curtain.tiledImage)){i=e.getContentSize(),t=e.viewportToImageCoordinates(a);var c=Math.min(i.y,Math.max(0,t.y));n=new OpenSeadragon.Rect(0,c,i.x,i.y),e.setClip(n)}},dragClip:function(e,i,t){i&&(this.clipFactorX=e.x/this.viewer.container.clientWidth),t&&(this.clipFactorY=e.y/this.viewer.container.clientHeight),this.updateClip()},getShownImages:function(){return this.images.filter(function(e){return e.shown})}},OpenSeadragon.EventSource.prototype);function o(o){var a=this;this.images=o.images,this.startingZoom=o.zoom,this.startingPan=o.pan,this.leadingImage=null,OpenSeadragon.EventSource.call(this),this.innerContainer=document.createElement("div"),this.innerContainer.style.display="flex",this.innerContainer.style.height="100%",o.container.appendChild(this.innerContainer),this.images.forEach(function(t,e){t.sync={},t.sync.container=document.createElement("div"),t.sync.container.style.flexGrow=1,a.innerContainer.appendChild(t.sync.container),t.shown||(t.sync.container.style.display="none");var i=o.osdOptions;i.element=t.sync.container,i.tileSources=t.tileSource,t.sync.viewer=OpenSeadragon(i),t.sync.viewer.canvas.style.outline="none",t.sync.viewer.addHandler("open",function(){if(a.startingZoom&&t.sync.viewer.viewport.zoomTo(a.startingZoom,null,!0),a.startingPan)t.sync.viewer.viewport.panTo(a.startingPan,!0);else{var e=t.sync.viewer.world.getHomeBounds(),i=new OpenSeadragon.Point(e.x+e.width/2,e.y+e.height/2);t.sync.viewer.viewport.panTo(i,!0)}}),t.sync.viewer.addHandler("add-item-failed",function(e){a.raiseEvent("add-item-failed",e)});function n(){a.leadingImage&&a.leadingImage!==t||(a.leadingImage=t,a.images.forEach(function(e){e!==t&&(e.sync.viewer.viewport.zoomTo(t.sync.viewer.viewport.getZoom()),e.sync.viewer.viewport.panTo(t.sync.viewer.viewport.getCenter()))}),a.leadingImage=null)}t.sync.viewer.addHandler("zoom",function(){n()}),t.sync.viewer.addHandler("pan",function(){n()}),0===e&&t.sync.viewer.addHandler("viewport-change",function(){a.raiseEvent("change:viewport")})})}o.prototype=OpenSeadragon.extend({destroy:function(){this.images.forEach(function(e){e.sync.container.parentNode.removeChild(e.sync.container),e.sync.viewer.destroy(),delete e.sync}),this.innerContainer.parentNode.removeChild(this.innerContainer)},getZoom:function(){return this.images[0].sync.viewer.viewport.getZoom()},setZoom:function(e){this.images[0].sync.viewer.viewport.zoomTo(e,null,!0),this.startingZoom=e},getPan:function(){return this.images[0].sync.viewer.viewport.getCenter()},setPan:function(e){this.images[0].sync.viewer.viewport.panTo(e,!0),this.startingPan=e},zoomIn:function(){var e=this.images[0].sync.viewer;e.viewport.zoomBy(e.zoomPerClick),e.viewport.applyConstraints()},zoomOut:function(){var e=this.images[0].sync.viewer;e.viewport.zoomBy(1/e.zoomPerClick),e.viewport.applyConstraints()},updateImageShown:function(e){e.sync.container.style.display=e.shown?"block":"none"}},OpenSeadragon.EventSource.prototype),window.CurtainSyncViewer=function(e){var n=this;console.assert(e,"[CurtainSyncViewer] args is required"),console.assert(e.container,"[CurtainSyncViewer] args.container is required"),console.assert(e.images,"[CurtainSyncViewer] args.images is required"),console.assert(0<e.images.length,"[CurtainSyncViewer] args.images must have at least 1 image"),OpenSeadragon.EventSource.call(this),this.container=e.container,this.viewportEventThrottle=e.viewportEventThrottle||250,this.lastViewportEventTime=0,this.images=[],this.osdOptions=e.osdOptions||{},this.osdOptions.showNavigationControl=!1,"static"===getComputedStyle(this.container).position&&(this.container.style.position="relative"),e.images.forEach(function(e,i){console.assert(e.key,"[CurtainSyncViewer] args.images["+i+"].key is required"),console.assert(e.tileSource,"[CurtainSyncViewer] args.images["+i+"].tileSource is required");var t={key:e.key,tileSource:e.tileSource,shown:!!e.shown};n.images.push(t)}),this.setMode(e.mode||"curtain")},window.CurtainSyncViewer.prototype=OpenSeadragon.extend({getMode:function(){return this.modeKey},setMode:function(e){var i=this;if(console.assert("curtain"===e||"sync"===e,"[CurtainSyncViewer.setMode] Must have valid key."),e!==this.modeKey){this.mode&&this.mode.destroy(),this.modeKey=e;var t={container:this.container,images:this.images,zoom:this.zoom,pan:this.pan,osdOptions:OpenSeadragon.extend({},this.osdOptions)};this.mode="curtain"===e?new n(t):new o(t),this.mode.addHandler("change:viewport",function(){i.handleViewportChange()}),this.mode.addHandler("add-item-failed",function(e){i.raiseEvent("open-failed",{message:e.message||"",tileSource:e.options?e.options.tileSource:void 0})}),this.raiseEvent("change:mode")}},getZoom:function(){return this.mode.getZoom()},setZoom:function(e){console.assert("number"==typeof e&&0<e&&e<1/0,"[CurtainSyncViewer.setZoom] zoom must be a positive number"),this.mode.setZoom(e),this.handleViewportChange()},zoomIn:function(){this.mode.zoomIn(),this.handleViewportChange()},zoomOut:function(){this.mode.zoomOut(),this.handleViewportChange()},getPan:function(){return this.mode.getPan()},setPan:function(e){console.assert("object"==typeof e&&"number"==typeof e.x&&"number"==typeof e.y,"[CurtainSyncViewer.setPan] pan must be an object with an x and a y"),this.mode.setPan(new OpenSeadragon.Point(e.x,e.y)),this.handleViewportChange()},getImageShown:function(i){var t=!1;return this.images.forEach(function(e){e.key===i&&e.shown&&(t=!0)}),t},setImageShown:function(i,t){var n=this;t=!!t;var o=!1;this.images.forEach(function(e){e.key===i&&e.shown!==t&&(o=!0,e.shown=t,n.mode.updateImageShown(e))}),o&&this.raiseEvent("change:imageShown",{key:i})},handleViewportChange:function(){var e=this,i=this.getZoom(),t=this.getPan();if(!(this.zoom===i&&this.pan&&this.pan.x===t.x&&this.pan.y===t.y||this.viewportEventTimeout)){var n=Date.now(),o=n-this.lastViewportEventTime;o<this.viewportEventThrottle?this.viewportEventTimeout=setTimeout(function(){e.viewportEventTimeout=null,e.raiseEvent("change:viewport"),e.lastViewportEventTime=Date.now()},this.viewportEventThrottle-o):(this.raiseEvent("change:viewport"),this.lastViewportEventTime=n)}this.zoom=i,this.pan=t}},OpenSeadragon.EventSource.prototype)}();
